#!/usr/bin/env node

/**
 * Generate Categories Metadata
 * 
 * Liest alle JSON-Dateien aus propData/ und generiert categories-metadata.json
 * Wird automatisch beim Build ausgefÃ¼hrt
 */

const fs = require('fs');
const path = require('path');

const propDataDir = path.join(__dirname, '../docs/.vitepress/theme/propData');
const outputPath = path.join(propDataDir, 'categories-metadata.json');

function toSlug(value) {
  return value
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

function toLabel(value) {
  return value
    .replace(/[_-]+/g, ' ')
    .split(' ')
    .filter(Boolean)
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

console.log('ðŸ“Š Generating categories metadata...');

// Finde alle JSON-Dateien (auÃŸer metadata, template und all.json)
const files = fs.readdirSync(propDataDir)
  .filter(file => 
    file.endsWith('.json') && 
    !file.startsWith('_') && 
    file !== 'categories-metadata.json' &&
    file !== 'all.json'  // Exclude all.json
  );

console.log(`Found ${files.length} category files`);

const categories = [];
let totalProps = 0;

files.forEach(file => {
  const filePath = path.join(propDataDir, file);
  const data = JSON.parse(fs.readFileSync(filePath, 'utf-8'));
  const slug = file.replace('.json', '');
  const label = toLabel(slug);
  
  // Check if it's new format (with metadata) or old format (just array)
  let props, subcategories;
  
  if (Array.isArray(data)) {
    // Old format: just array of props
    props = data;
    
    // Build subcategories from props
    const subMap = new Map();
    props.forEach(prop => {
      if (prop.subcategory) {
        const subSlug = toSlug(prop.subcategory);
        if (!subMap.has(subSlug)) {
          subMap.set(subSlug, { slug: subSlug, label: toLabel(prop.subcategory), count: 0 });
        }
        subMap.get(subSlug).count++;
      }
    });
    subcategories = Array.from(subMap.values()).sort((a, b) => a.label.localeCompare(b.label));
    
  } else {
    // New format: with metadata
    props = data.props || [];
    
    // Use defined subcategories from metadata
    if (data.metadata?.subcategories) {
      subcategories = data.metadata.subcategories.map(sub => {
        const subSlug = toSlug(sub.name);
        return {
          slug: subSlug,
          label: toLabel(sub.name),
          count: props.filter(p => toSlug(p.subcategory ?? '') === subSlug).length
        };
      });
    } else {
      // Fallback: extract from props
      const subMap = new Map();
      props.forEach(prop => {
        if (prop.subcategory) {
          const subSlug = toSlug(prop.subcategory);
          if (!subMap.has(subSlug)) {
            subMap.set(subSlug, { slug: subSlug, label: toLabel(prop.subcategory), count: 0 });
          }
          subMap.get(subSlug).count++;
        }
      });
      subcategories = Array.from(subMap.values()).sort((a, b) => a.label.localeCompare(b.label));
    }
  }

  categories.push({
    slug,
    label,
    count: props.length,
    subcategories: subcategories
  });
  
  totalProps += props.length;
  
  console.log(`  âœ“ ${label.padEnd(30)} ${props.length.toString().padStart(6)} props`);
});

// Sort categories (Spooni Props first, then alphabetical)
categories.sort((a, b) => {
  if (a.slug === "spooni-props") return -1;
  if (b.slug === "spooni-props") return 1;
  return a.label.localeCompare(b.label);
});

// Create metadata
const metadata = {
  totalProps: totalProps,
  categories: categories
};

// Write metadata file
fs.writeFileSync(outputPath, JSON.stringify(metadata, null, 2), 'utf-8');

// Update constants.ts with the new total
const constantsPath = path.join(__dirname, '../docs/.vitepress/theme/constants.ts');
let constantsContent = fs.readFileSync(constantsPath, 'utf-8');
constantsContent = constantsContent.replace(
  /TOTAL_PROPS_ESTIMATE:\s*\d+,\s*\/\/ Auto-generated by generate-categories-metadata\.js/,
  `TOTAL_PROPS_ESTIMATE: ${totalProps}, // Auto-generated by generate-categories-metadata.js`
);
fs.writeFileSync(constantsPath, constantsContent, 'utf-8');

console.log('');
console.log(`âœ… Generated categories-metadata.json`);
console.log(`   Total categories: ${categories.length}`);
console.log(`   Total props: ${totalProps}`);
console.log(`âœ… Updated constants.ts with total props count`);
console.log('');

